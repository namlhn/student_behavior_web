{% extends "layout.html" %}
{% block content %}
<header class="mb-6">
  <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold flex items-center gap-2">
        <i data-lucide="camera" class="w-8 h-8 text-primary"></i>
        Face Recognition Training
      </h1>
      <p class="text-sm text-base-content/60 mt-1">Upload multiple face photos for better AI recognition accuracy</p>
    </div>
    <a href="/ui/students" class="btn btn-ghost gap-2">
      <i data-lucide="arrow-left" class="w-4 h-4"></i>
      Back to Students
    </a>
  </div>
  
  <!-- Student Info Card -->
  <div class="mt-6 bg-base-100 rounded-box shadow p-4" x-show="$store.faces.student">
    <div class="flex items-center gap-4">
      <div class="avatar">
        <div class="w-16 h-16 rounded-full">
          <template x-if="$store.faces.student?.photo_path">
            <img :src="$store.faces.student.photo_path" alt="Student photo" class="object-cover" />
          </template>
          <template x-if="!$store.faces.student?.photo_path">
            <div class="bg-base-300 flex items-center justify-center">
              <i data-lucide="user" class="w-8 h-8 text-base-content/40"></i>
            </div>
          </template>
        </div>
      </div>
      <div class="flex-1">
        <h2 class="text-xl font-bold" x-text="$store.faces.student?.name"></h2>
        <div class="flex flex-wrap gap-4 text-sm text-base-content/60 mt-1">
          <span class="flex items-center gap-1">
            <i data-lucide="hash" class="w-3 h-3"></i>
            <span x-text="$store.faces.student?.student_code || 'No code'"></span>
          </span>
          <span class="flex items-center gap-1" x-show="$store.faces.student?.class_name">
            <i data-lucide="graduation-cap" class="w-3 h-3"></i>
            <span x-text="$store.faces.student?.class_name"></span>
          </span>
          <span class="flex items-center gap-1" x-show="$store.faces.student?.email">
            <i data-lucide="mail" class="w-3 h-3"></i>
            <span x-text="$store.faces.student?.email"></span>
          </span>
        </div>
      </div>
      <div class="text-right">
        <div class="stat">
          <div class="stat-figure text-primary">
            <i data-lucide="brain" class="w-6 h-6"></i>
          </div>
          <div class="stat-title">AI Embeddings</div>
          <div class="stat-value text-primary" x-text="$store.faces.student?.face_embedding_count || 0"></div>
          <div class="stat-desc">Recognition data points</div>
        </div>
      </div>
    </div>
  </div>
</header>

<section class="mb-6 bg-base-100 rounded-box shadow p-6">
  <h2 class="font-semibold text-lg mb-4 flex items-center gap-2">
    <i data-lucide="upload" class="w-5 h-5"></i>
    Batch Upload Photos
  </h2>
  <div class="bg-base-200 rounded-lg p-4 mb-4">
    <div class="flex items-start gap-3">
      <i data-lucide="info" class="w-5 h-5 text-info mt-0.5"></i>
      <div class="text-sm">
        <p class="font-medium mb-1">Upload Tips:</p>
        <ul class="list-disc list-inside space-y-1 text-base-content/70">
          <li>Upload multiple clear photos of the same person for better accuracy</li>
          <li>Ensure good lighting and the face is clearly visible</li>
          <li>Supported formats: JPG, PNG, GIF</li>
          <li>Recommended: 5-10 photos from different angles</li>
        </ul>
      </div>
    </div>
  </div>
  
  <form class="space-y-4" @submit.prevent="$store.faces.uploadBatch($event.target)">
    <div class="form-control">
      <label class="label">
        <span class="label-text font-medium">Select Photos</span>
      </label>
      <input type="file" name="files" accept="image/*" multiple required 
             class="file-input file-input-bordered file-input-primary w-full" 
             @change="$store.faces.updateFileInfo($event)" />
      <label class="label">
        <span class="label-text-alt" x-text="$store.faces.fileInfo"></span>
      </label>
    </div>
    
    <div class="flex items-center gap-3">
      <button type="submit" class="btn btn-primary gap-2" :disabled="$store.faces.uploading">
        <i data-lucide="upload" class="w-4 h-4"></i>
        <span x-show="!$store.faces.uploading">Upload Photos</span>
        <span x-show="$store.faces.uploading">Uploading...</span>
        <span class="loading loading-spinner loading-sm" x-show="$store.faces.uploading"></span>
      </button>
      <div class="text-sm text-base-content/60" x-text="$store.faces.uploadInfo"></div>
    </div>
  </form>
</section>

<section class="bg-base-100 rounded-box shadow p-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="font-semibold text-lg flex items-center gap-2">
      <i data-lucide="images" class="w-5 h-5"></i>
      Training Photos
    </h2>
    <div class="flex items-center gap-4">
      <div class="text-sm text-base-content/60">
        <span x-text="$store.faces.photos.length"></span> photos uploaded
      </div>
      <button class="btn btn-sm btn-ghost gap-1" @click="$store.faces.refreshPhotos()">
        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
        Refresh
      </button>
    </div>
  </div>
  
  <template x-if="$store.faces.loading">
    <div class="py-12 text-center">
      <span class="loading loading-spinner loading-lg"></span>
      <p class="mt-2 text-base-content/60">Loading photos...</p>
    </div>
  </template>
  
  <template x-if="$store.faces.error">
    <div role="alert" class="alert alert-error mb-4">
      <i data-lucide="alert-circle" class="w-5 h-5"></i>
      <span x-text="$store.faces.error"></span>
    </div>
  </template>

  <template x-if="!$store.faces.loading && $store.faces.photos.length === 0">
    <div class="py-12 text-center">
      <i data-lucide="image-off" class="w-16 h-16 text-base-content/20 mx-auto mb-4"></i>
      <p class="text-base-content/60 mb-2">No photos uploaded yet</p>
      <p class="text-sm text-base-content/40">Upload some photos to start training the AI recognition system</p>
    </div>
  </template>

  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4" x-show="$store.faces.photos.length > 0">
    <template x-for="p in $store.faces.photos" :key="p.id || p.photo_path">
      <div class="card bg-base-200 shadow-sm hover:shadow-md transition-shadow">
        <figure class="h-32 overflow-hidden rounded-t-lg">
          <img :src="p.photo_path" alt="Training photo" class="w-full h-full object-cover hover:scale-105 transition-transform cursor-pointer"
               @click="$store.faces.viewPhoto(p.photo_path)" />
        </figure>
        <div class="card-body p-2">
          <div class="text-xs text-base-content/60 flex items-center gap-1">
            <i data-lucide="calendar" class="w-3 h-3"></i>
            <span x-text="$store.faces.formatDate(p.created_at)"></span>
          </div>
        </div>
      </div>
    </template>
  </div>
</section>

<!-- Photo Viewer Modal -->
<dialog id="photo_viewer_modal" class="modal">
  <div class="modal-box max-w-2xl">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
    </form>
    <h3 class="font-bold text-lg mb-4">Photo Viewer</h3>
    <div class="flex justify-center">
      <img :src="$store.faces.selectedPhoto" alt="Selected photo" class="max-w-full max-h-96 object-contain rounded-lg" />
    </div>
  </div>
</dialog>
{% endblock %}

{% block body_scripts %}
<script>
  function getParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  document.addEventListener('alpine:init', () => {
    Alpine.store('faces', {
      studentId: null,
      student: null,
      photos: [],
      loading: false,
      error: '',
      uploadInfo: '',
      uploading: false,
      fileInfo: '',
      selectedPhoto: null,
      async init(){
        this.studentId = getParam('studentId');
        if(!this.studentId){ 
          this.error = 'Missing studentId parameter'; 
          return; 
        }
        
        await this.loadData();
        
        // Initialize Lucide icons
        this.$nextTick(() => {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        });
      },
      
      async loadData(){
        this.loading = true;
        this.error = '';
        try {
          // Load student info
          const sRes = await fetch(`/api/students/${this.studentId}`);
          const sData = await sRes.json();
          if(sData && sData.result === 'success') {
            this.student = sData.reply;
          } else {
            this.error = 'Student not found';
            return;
          }

          // Load photos
          await this.loadPhotos();
        } catch (e) {
          this.error = 'Failed to load data: ' + e.message;
        } finally {
          this.loading = false;
        }
      },
      
      async loadPhotos(){
        try {
          const pRes = await fetch(`/api/students/${this.studentId}/photos`);
          const pData = await pRes.json();
          if(pData && pData.result === 'success') {
            this.photos = Array.isArray(pData.reply) ? pData.reply : [];
          }
        } catch (e) {
          console.error('Failed to load photos:', e);
        }
      },
      
      async refreshPhotos(){
        await this.loadPhotos();
        this.$nextTick(() => {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        });
      },
      
      updateFileInfo(event){
        const files = event.target.files;
        if (files && files.length > 0) {
          this.fileInfo = `${files.length} file(s) selected`;
        } else {
          this.fileInfo = '';
        }
      },
      
      viewPhoto(photoPath){
        this.selectedPhoto = photoPath;
        document.getElementById('photo_viewer_modal').showModal();
      },
      
      formatDate(dateString){
        if (!dateString) return '';
        try {
          return new Date(dateString).toLocaleDateString();
        } catch (e) {
          return '';
        }
      },
      async uploadBatch(form){
        const input = form.querySelector('input[type="file"][name="files"]');
        if (!input.files || input.files.length === 0) {
          this.showToast('Please select at least one file', 'warning');
          return;
        }
        
        this.uploading = true;
        this.uploadInfo = '';
        
        try{
          const fd = new FormData();
          for(const f of input.files){ 
            fd.append('files', f); 
          }
          
          const res = await fetch(`/api/students/${this.studentId}/faces/batch`, { 
            method: 'POST', 
            body: fd 
          });
          
          const data = await res.json();
          if(data && data.result === 'success'){
            const reply = data.reply || {};
            const addedCount = reply.added?.length || 0;
            const embeddingsCount = reply.embeddings_added || 0;
            
            this.uploadInfo = `Successfully uploaded ${addedCount} photos, ${embeddingsCount} AI embeddings created`;
            
            // Refresh photos and student data
            await this.loadPhotos();
            if(reply.student) {
              this.student = reply.student;
            }
            
            // Reset form and file info
            form.reset();
            this.fileInfo = '';
            
            this.showToast(`Upload completed! ${addedCount} photos processed.`, 'success');
          } else {
            this.showToast(data.message || 'Upload failed', 'error');
          }
        }catch(e){
          this.showToast('Upload failed: ' + e.message, 'error');
        } finally {
          this.uploading = false;
          this.$nextTick(() => {
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
          });
        }
      },
      
      showToast(message, type = 'info'){
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} fixed top-4 right-4 z-50 w-auto max-w-md shadow-lg`;
        toast.innerHTML = `<span>${message}</span>`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 4000);
      }
    });
  });
</script>
{% endblock %}
