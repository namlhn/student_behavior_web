{% extends "layout.html" %}
{% block content %}
<header class="mb-6">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold flex items-center gap-2">
        <i data-lucide="users" class="w-8 h-8 text-primary"></i>
        Students Management
      </h1>
      <p class="text-sm text-base-content/60 mt-1">Manage student information and face recognition data</p>
    </div>
    <button class="btn btn-primary gap-2" @click="$store.app.openAddModal()">
      <i data-lucide="user-plus" class="w-4 h-4"></i>
      Add Student
    </button>
  </div>
  
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
    <div class="stats shadow">
      <div class="stat">
        <div class="stat-figure text-primary">
          <i data-lucide="users" class="w-8 h-8"></i>
        </div>
        <div class="stat-title">Total Students</div>
        <div class="stat-value text-primary" x-text="$store.app.stats.total || 0"></div>
      </div>
    </div>
    <div class="stats shadow">
      <div class="stat">
        <div class="stat-figure text-success">
          <i data-lucide="user-check" class="w-8 h-8"></i>
        </div>
        <div class="stat-title">Active</div>
        <div class="stat-value text-success" x-text="$store.app.stats.active || 0"></div>
      </div>
    </div>
    <div class="stats shadow">
      <div class="stat">
        <div class="stat-figure text-info">
          <i data-lucide="camera" class="w-8 h-8"></i>
        </div>
        <div class="stat-title">With Photos</div>
        <div class="stat-value text-info" x-text="$store.app.stats.withPhotos || 0"></div>
      </div>
    </div>
    <div class="stats shadow">
      <div class="stat">
        <div class="stat-figure text-warning">
          <i data-lucide="brain" class="w-8 h-8"></i>
        </div>
        <div class="stat-title">AI Trained</div>
        <div class="stat-value text-warning" x-text="$store.app.stats.withEmbeddings || 0"></div>
      </div>
    </div>
  </div>
</header>

<!-- Search and Filters -->
<section class="bg-base-100 rounded-box shadow p-4 mb-6">
  <div class="flex flex-col lg:flex-row gap-4">
    <div class="flex-1">
      <div class="form-control">
        <div class="input-group">
          <input type="text" placeholder="Search by name, code, email, or class..." 
                 class="input input-bordered flex-1" 
                 x-model="$store.app.searchTerm"
                 @input.debounce.300ms="$store.app.search()">
          <button class="btn btn-square" @click="$store.app.search()">
            <i data-lucide="search" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="flex gap-2">
      <select class="select select-bordered" x-model="$store.app.statusFilter" @change="$store.app.search()">
        <option value="">All Status</option>
        <option value="Active">Active</option>
        <option value="Inactive">Inactive</option>
        <option value="Graduated">Graduated</option>
      </select>
      <button class="btn btn-ghost gap-2" @click="$store.app.resetFilters()">
        <i data-lucide="x" class="w-4 h-4"></i>
        Clear
      </button>
    </div>
  </div>
</section>

<section class="bg-base-100 rounded-box shadow p-4">
  <div class="flex items-center justify-between mb-4">
    <h2 class="font-semibold text-lg flex items-center gap-2">
      <i data-lucide="list" class="w-5 h-5"></i>
      Students List
    </h2>
    <div class="flex items-center gap-4">
      <div class="text-sm text-base-content/60">
        <span x-text="$store.app.pagination.total || 0"></span> total students
      </div>
      <div class="flex gap-2">
        <button class="btn btn-sm btn-ghost gap-1" @click="$store.app.exportData()">
          <i data-lucide="download" class="w-4 h-4"></i>
          Export
        </button>
      </div>
    </div>
  </div>
  <template x-if="$store.app.loading">
    <div class="py-8 text-center text-base-content/60">
      <span class="loading loading-spinner loading-md"></span>
    </div>
  </template>
  <template x-if="$store.app.error">
    <div role="alert" class="alert alert-error mb-3">
      <span x-text="$store.app.error"></span>
    </div>
  </template>

  <div class="overflow-x-auto">
    <table class="table table-zebra">
      <thead>
        <tr>
          <th>Photo</th>
          <th>Student Info</th>
          <th>Contact</th>
          <th>Academic</th>
          <th>Status</th>
          <th>AI Data</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="student in $store.app.students" :key="student.id">
          <tr>
            <td>
              <div class="avatar">
                <div class="w-12 h-12 rounded-full">
                  <template x-if="student.photo_path">
                    <img :src="student.photo_path" alt="Student photo" class="object-cover" />
                  </template>
                  <template x-if="!student.photo_path">
                    <div class="bg-base-300 flex items-center justify-center">
                      <i data-lucide="user" class="w-6 h-6 text-base-content/40"></i>
                    </div>
                  </template>
                </div>
              </div>
            </td>
            <td>
              <div class="flex flex-col">
                <div class="font-bold" x-text="student.name"></div>
                <div class="text-sm opacity-50 flex items-center gap-1">
                  <i data-lucide="hash" class="w-3 h-3"></i>
                  <span x-text="student.student_code || 'No code'"></span>
                </div>
                <template x-if="student.date_of_birth">
                  <div class="text-xs opacity-40 flex items-center gap-1 mt-1">
                    <i data-lucide="calendar" class="w-3 h-3"></i>
                    <span x-text="new Date(student.date_of_birth).toLocaleDateString()"></span>
                  </div>
                </template>
              </div>
            </td>
            <td>
              <div class="flex flex-col gap-1">
                <template x-if="student.email">
                  <div class="text-sm flex items-center gap-1">
                    <i data-lucide="mail" class="w-3 h-3"></i>
                    <span x-text="student.email"></span>
                  </div>
                </template>
                <template x-if="student.phone">
                  <div class="text-sm flex items-center gap-1">
                    <i data-lucide="phone" class="w-3 h-3"></i>
                    <span x-text="student.phone"></span>
                  </div>
                </template>
                <template x-if="!student.email && !student.phone">
                  <span class="text-xs opacity-40">No contact info</span>
                </template>
              </div>
            </td>
            <td>
              <div class="flex flex-col gap-1">
                <template x-if="student.class_name">
                  <div class="badge badge-outline badge-sm">
                    <span x-text="student.class_name"></span>
                  </div>
                </template>
                <template x-if="student.major">
                  <div class="text-xs opacity-60" x-text="student.major"></div>
                </template>
                <template x-if="student.gpa">
                  <div class="text-xs flex items-center gap-1">
                    <i data-lucide="star" class="w-3 h-3"></i>
                    <span>GPA: </span><span x-text="student.gpa"></span>
                  </div>
                </template>
              </div>
            </td>
            <td>
              <div class="badge" 
                   :class="{
                     'badge-success': student.status === 'Active',
                     'badge-warning': student.status === 'Inactive', 
                     'badge-info': student.status === 'Graduated'
                   }"
                   x-text="student.status || 'Active'">
              </div>
            </td>
            <td>
              <div class="flex flex-col gap-1">
                <div class="badge badge-outline badge-sm flex items-center gap-1">
                  <i data-lucide="camera" class="w-3 h-3"></i>
                  <span x-text="student.face_embedding_count || 0"></span>
                </div>
                <template x-if="student.face_embedding_count > 0">
                  <div class="text-xs text-success flex items-center gap-1">
                    <i data-lucide="check" class="w-3 h-3"></i>
                    AI Ready
                  </div>
                </template>
              </div>
            </td>
            <td>
              <div class="flex flex-wrap gap-1">
                <button class="btn btn-ghost btn-xs gap-1" @click="$store.app.openEditModal(student)">
                  <i data-lucide="edit" class="w-3 h-3"></i>
                  Edit
                </button>
                <a :href="'/ui/faces?studentId=' + student.id" class="btn btn-ghost btn-xs gap-1">
                  <i data-lucide="camera" class="w-3 h-3"></i>
                  Faces
                </a>
                <button class="btn btn-error btn-xs gap-1" @click="$store.app.deleteStudent(student.id)">
                  <i data-lucide="trash-2" class="w-3 h-3"></i>
                  Delete
                </button>
              </div>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  <div class="flex justify-between items-center mt-4">
    <div class="text-sm text-base-content/60">
      Showing <span x-text="$store.app.pagination.skip + 1"></span> to 
      <span x-text="Math.min($store.app.pagination.skip + $store.app.pagination.limit, $store.app.pagination.total)"></span> 
      of <span x-text="$store.app.pagination.total"></span> students
    </div>
    <div class="join">
      <button class="join-item btn btn-sm" :disabled="$store.app.pagination.skip === 0" @click="$store.app.prevPage()">
        <i data-lucide="chevron-left" class="w-4 h-4"></i>
      </button>
      <button class="join-item btn btn-sm btn-active">
        Page <span x-text="Math.floor($store.app.pagination.skip / $store.app.pagination.limit) + 1"></span>
      </button>
      <button class="join-item btn btn-sm" 
              :disabled="$store.app.pagination.skip + $store.app.pagination.limit >= $store.app.pagination.total" 
              @click="$store.app.nextPage()">
        <i data-lucide="chevron-right" class="w-4 h-4"></i>
      </button>
    </div>
  </div>
</section>

<!-- Add/Edit Modal -->
<dialog id="student_modal" class="modal">
  <div class="modal-box max-w-4xl">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
    </form>
    <h3 class="font-bold text-xl flex items-center gap-2 mb-6">
      <i data-lucide="user-plus" class="w-6 h-6" x-show="$store.app.mode==='add'"></i>
      <i data-lucide="user-edit" class="w-6 h-6" x-show="$store.app.mode==='edit'"></i>
      <span x-text="$store.app.mode==='add' ? 'Add New Student' : 'Edit Student'"></span>
    </h3>
    
    <!-- Personal Information -->
    <div class="mb-6">
      <h4 class="font-semibold text-lg mb-3 flex items-center gap-2">
        <i data-lucide="user" class="w-5 h-5"></i>
        Personal Information
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Full Name *</span></label>
          <input type="text" class="input input-bordered" x-model="$store.app.form.name" placeholder="e.g. Nguyen Van A" required />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Student Code</span></label>
          <input type="text" class="input input-bordered" x-model="$store.app.form.student_code" placeholder="e.g. SV20240001" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Date of Birth</span></label>
          <input type="date" class="input input-bordered" x-model="$store.app.form.date_of_birth" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Gender</span></label>
          <select class="select select-bordered" x-model="$store.app.form.gender">
            <option value="">Select gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-control md:col-span-2">
          <label class="label"><span class="label-text font-medium">Address</span></label>
          <textarea class="textarea textarea-bordered" x-model="$store.app.form.address" placeholder="Full address" rows="2"></textarea>
        </div>
      </div>
    </div>

    <!-- Contact Information -->
    <div class="mb-6">
      <h4 class="font-semibold text-lg mb-3 flex items-center gap-2">
        <i data-lucide="contact" class="w-5 h-5"></i>
        Contact Information
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Email</span></label>
          <input type="email" class="input input-bordered" x-model="$store.app.form.email" placeholder="student@example.com" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Phone Number</span></label>
          <input type="tel" class="input input-bordered" x-model="$store.app.form.phone" placeholder="0123456789" />
        </div>
      </div>
    </div>

    <!-- Academic Information -->
    <div class="mb-6">
      <h4 class="font-semibold text-lg mb-3 flex items-center gap-2">
        <i data-lucide="graduation-cap" class="w-5 h-5"></i>
        Academic Information
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Class</span></label>
          <input type="text" class="input input-bordered" x-model="$store.app.form.class_name" placeholder="e.g. 10A1" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Course</span></label>
          <input type="text" class="input input-bordered" x-model="$store.app.form.course" placeholder="e.g. K2024" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Major</span></label>
          <input type="text" class="input input-bordered" x-model="$store.app.form.major" placeholder="e.g. Computer Science" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Academic Level</span></label>
          <select class="select select-bordered" x-model="$store.app.form.academic_level">
            <option value="">Select level</option>
            <option value="Excellent">Excellent</option>
            <option value="Good">Good</option>
            <option value="Average">Average</option>
            <option value="Below Average">Below Average</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">GPA</span></label>
          <input type="number" step="0.01" min="0" max="4" class="input input-bordered" x-model="$store.app.form.gpa" placeholder="e.g. 3.5" />
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-medium">Status</span></label>
          <select class="select select-bordered" x-model="$store.app.form.status">
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
            <option value="Graduated">Graduated</option>
          </select>
        </div>
      </div>
    </div>

    <div class="modal-action">
      <button class="btn btn-ghost" @click="document.getElementById('student_modal').close()">Cancel</button>
      <button class="btn btn-primary gap-2" @click.prevent="$store.app.submitForm()" :disabled="$store.app.submitting">
        <i data-lucide="save" class="w-4 h-4"></i>
        <span x-text="$store.app.mode==='add' ? 'Add Student' : 'Save Changes'"></span>
        <span class="loading loading-spinner loading-sm" x-show="$store.app.submitting"></span>
      </button>
    </div>
  </div>
</dialog>
{% endblock %}

{% block body_scripts %}
<script>
  document.addEventListener('alpine:init', () => {
    Alpine.store('app', {
      students: [],
      loading: false,
      error: '',
      submitting: false,
      mode: 'add',
      currentId: null,
      searchTerm: '',
      statusFilter: '',
      pagination: {
        skip: 0,
        limit: 20,
        total: 0
      },
      stats: {
        total: 0,
        active: 0,
        withPhotos: 0,
        withEmbeddings: 0
      },
      form: {
        name: '', student_code: '', email: '', phone: '', date_of_birth: '',
        gender: '', address: '', class_name: '', academic_level: '', 
        course: '', major: '', gpa: '', status: 'Active'
      },
      async init(){
        await this.loadStudents();
        // Initialize Lucide icons after DOM updates
        this.$nextTick(() => {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        });
      },
      
      async loadStudents(){
        this.loading = true;
        this.error = '';
        try {
          const params = new URLSearchParams({
            skip: this.pagination.skip,
            limit: this.pagination.limit
          });
          if (this.searchTerm) params.append('search', this.searchTerm);
          if (this.statusFilter) params.append('status', this.statusFilter);
          
          const res = await fetch(`/api/students?${params}`);
          const data = await res.json();
          if(data && data.result === 'success') {
            this.students = data.reply?.items || [];
            this.pagination.total = data.reply?.total || 0;
            this.updateStats();
          } else {
            this.error = data.message || 'Failed to load students';
          }
        } catch (e) {
          this.error = 'Failed to load students';
        } finally {
          this.loading = false;
          this.$nextTick(() => {
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
          });
        }
      },
      
      updateStats(){
        this.stats.total = this.pagination.total;
        this.stats.active = this.students.filter(s => s.status === 'Active').length;
        this.stats.withPhotos = this.students.filter(s => s.photo_path).length;
        this.stats.withEmbeddings = this.students.filter(s => s.face_embedding_count > 0).length;
      },
      
      async search(){
        this.pagination.skip = 0;
        await this.loadStudents();
      },
      
      resetFilters(){
        this.searchTerm = '';
        this.statusFilter = '';
        this.pagination.skip = 0;
        this.loadStudents();
      },
      
      async nextPage(){
        if (this.pagination.skip + this.pagination.limit < this.pagination.total) {
          this.pagination.skip += this.pagination.limit;
          await this.loadStudents();
        }
      },
      
      async prevPage(){
        if (this.pagination.skip > 0) {
          this.pagination.skip = Math.max(0, this.pagination.skip - this.pagination.limit);
          await this.loadStudents();
        }
      },
      openAddModal(){
        this.mode = 'add';
        this.currentId = null;
        this.form = {
          name: '', student_code: '', email: '', phone: '', date_of_birth: '',
          gender: '', address: '', class_name: '', academic_level: '', 
          course: '', major: '', gpa: '', status: 'Active'
        };
        document.getElementById('student_modal').showModal();
        this.$nextTick(() => {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        });
      },
      
      openEditModal(st){
        this.mode = 'edit';
        this.currentId = st.id;
        this.form = {
          name: st.name || '',
          student_code: st.student_code || '',
          email: st.email || '',
          phone: st.phone || '',
          date_of_birth: st.date_of_birth || '',
          gender: st.gender || '',
          address: st.address || '',
          class_name: st.class_name || '',
          academic_level: st.academic_level || '',
          course: st.course || '',
          major: st.major || '',
          gpa: st.gpa || '',
          status: st.status || 'Active'
        };
        document.getElementById('student_modal').showModal();
        this.$nextTick(() => {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        });
      },
      async submitForm(){
        if (!this.form.name) {
          alert('Name is required');
          return;
        }
        
        this.submitting = true;
        try{
          const fd = new FormData();
          
          // Add all form fields
          Object.keys(this.form).forEach(key => {
            if (this.form[key] !== null && this.form[key] !== '') {
              fd.append(key, this.form[key]);
            }
          });
          
          let res;
          if(this.mode === 'add'){
            res = await fetch('/api/students', { method: 'POST', body: fd });
          } else {
            res = await fetch(`/api/students/${this.currentId}`, { method: 'PUT', body: fd });
          }
          
          const payload = await res.json();
          if(payload && payload.result === 'success' && payload.reply){
            document.getElementById('student_modal').close();
            await this.loadStudents(); // Reload to get updated data
            
            // Show success message
            this.showToast('Student saved successfully!', 'success');
          } else {
            this.showToast(payload.message || 'Save failed', 'error');
          }
        }catch(e){
          this.showToast('Save failed: ' + e.message, 'error');
        } finally {
          this.submitting = false;
        }
      },
      
      async deleteStudent(studentId){
        if (!confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
          return;
        }
        
        try {
          const res = await fetch(`/api/students/${studentId}`, { method: 'DELETE' });
          const payload = await res.json();
          if(payload && payload.result === 'success'){
            await this.loadStudents();
            this.showToast('Student deleted successfully!', 'success');
          } else {
            this.showToast('Delete failed', 'error');
          }
        } catch(e) {
          this.showToast('Delete failed: ' + e.message, 'error');
        }
      },
      
      exportData(){
        const csvContent = this.generateCSV();
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `students_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      },
      
      generateCSV(){
        const headers = ['ID', 'Student Code', 'Name', 'Email', 'Phone', 'Date of Birth', 'Gender', 'Address', 'Class', 'Course', 'Major', 'Academic Level', 'GPA', 'Status', 'Face Embeddings'];
        const rows = this.students.map(s => [
          s.id, s.student_code || '', s.name || '', s.email || '', s.phone || '',
          s.date_of_birth || '', s.gender || '', s.address || '', s.class_name || '',
          s.course || '', s.major || '', s.academic_level || '', s.gpa || '',
          s.status || '', s.face_embedding_count || 0
        ]);
        
        return [headers, ...rows].map(row => 
          row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
        ).join('\n');
      },
      
      showToast(message, type = 'info'){
        // Simple toast implementation
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} fixed top-4 right-4 z-50 w-auto max-w-md shadow-lg`;
        toast.innerHTML = `<span>${message}</span>`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      },
      addStudent(s){ if(s && s.id){ this.students.push(s); } },
      replaceStudent(s){
        if(!s || !s.id) return;
        const i = this.students.findIndex(x => x.id === s.id);
        if(i >= 0) this.students.splice(i, 1, s); else this.students.push(s);
      },
      removeStudent(id){ this.students = this.students.filter(x => x.id !== id); }
    });
  });
</script>
{% endblock %}
